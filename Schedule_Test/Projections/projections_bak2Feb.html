<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>COA Course Projections</title>
  <!-- DataTables CSS -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css" />
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background-color:#C6D9F7}
    h1, h2 { text-align: center; color:#294C84; }
    table { width: 100%; }
    .filters {
      margin: 1em 0;
      text-align: center;
      display: flex;
      gap: 1rem;
      justify-content: center;
      flex-wrap: wrap;
    }
    .filters label { margin: 0 0.25em; }
    select { padding: 6px 8px; }

    .course-link, .bonus-link {
      background: none;
      border: none;
      padding: 0;
      text-decoration: underline;
      cursor: pointer;
      font: inherit;
    }

/* Make all filter boxes a warm yellow */
.filters select,
.filters input[type="text"] {
  background-color: #A6B9D7;
  border: 2px solid #693827;
  padding: 6px 8px;
  border-radius: 4px;
}

/* Optional: darken on focus for accessibility */
.filters select:focus,
.filters input[type="text"]:focus {
  outline: none;
  background-color: #BCEBD7;
  border-color: #8C6E1E;
}

/* Top scrollbar */
.top-scroll {
  overflow-x: auto;
  overflow-y: hidden;
  height: 16px;          /* just enough to show scrollbar */
  margin-top: 50px;
  margin-bottom: -20px;
  /* background: #ff00ff; */
  border: 2px solid #693827
}

.top-scroll-inner {
  height: 1px;           /* invisible content */
}

/* Make sure bottom scroll stays active */
.term-tables {
  overflow-x: auto;
}

    
    /* Layout for term columns */
    /*.term-tables {
      display: flex;
      gap: 1.5rem;
      align-items: flex-start;
      flex-wrap: nowrap;
      overflow-x: auto;
      margin-top: 1rem;
    }
    .term-column {
      min-width: 360px;
      flex: 1 0 360px;
    }*/

    .term-tables {
	display: block;
	overflow-x: auto;      /* horizontal scroll when needed */
	white-space: nowrap;   /* keep columns on one line */
	margin-top: 1rem;
    }
    
    .term-column {
	display: inline-block; /* line them up left-to-right */
	vertical-align: top;
	width: 920px;          /* adjust width if you like */
	margin-right: 1.5rem;
    }
    
    .term-column table {
	width: 100%;
	table-layout: fixed;   /* helps prevent weird squeezing */
    }

/* Column width controls (applies to all term tables) */
.term-column table th:nth-child(1),
.term-column table td:nth-child(1) {
  width: 110px;   /* Faculty Name */
}

.term-column table th:nth-child(2),
.term-column table td:nth-child(2) {
  width: 330px;   /* Course Name */
}

.term-column table th:nth-child(3),
.term-column table td:nth-child(3) {
  width: 40px;   /* Requirements */
}

.term-column table th:nth-child(4),
.term-column table td:nth-child(4) {
  width: 30px;   /* Level */
}

.term-column table th:nth-child(5),
.term-column table td:nth-child(5) {
  width: 70px;   /* Bonus Info (visible cell) */
}

    
    .term-column h3 {
      text-align: center;
      margin-bottom: 0.5rem;
      color: #693827;
    }

    /* Modal styles */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.35);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    .modal {
      background: #fff;
      max-width: 720px;
      width: 92%;
      border-radius: 10px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.25);
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 14px 18px;
      border-bottom: 1px solid #eee;
    }
    .modal-title { font-weight: 600; }
    .modal-close {
      background: none;
      border: none;
      font-size: 22px;
      line-height: 1;
      cursor: pointer;
    }
    .modal-body {
      padding: 16px 18px;
      white-space: pre-wrap;
    }
    .subtitle {
      font-size: 0.9em;
      color: #555;
      margin-top: 2px;
    }

    /* Scroll hint container */
    .scroll-hint {
	position: relative;
    }
    
    /* The fading arrow overlay */
    .scroll-hint::after {
	content: "→ scroll";
	position: absolute;
	top: 50%;
	right: 4px;
	transform: translateY(-50%);
	padding: 4px 8px;
	font-size: 0.85em;
	color: #444;
	background: linear-gradient(to right, rgba(255,255,255,0), rgba(255,255,255,0.85));
	border-radius: 4px 0 0 4px;
	pointer-events: none;
	opacity: 0;
	transition: opacity 0.3s;
    }
    
    /* Show the hint when scrolling is possible */
    .scroll-hint.scrollable::after {
	opacity: 1;
    }
    
    /* Hide hint on wide screens */
    @media (min-width: 1100px) {
	.scroll-hint::after {
	    display: none;
	}
}

.help-icon {
  margin-left: 6px;
  width: 22px;
  height: 22px;
  border-radius: 999px;
  border: 1px solid #777;
  background: #FFE498;       /* matches your input color */
  color: #222;
  font-weight: 700;
  line-height: 20px;
  cursor: pointer;
}

.help-popover {
  display: none;
  position: absolute;
  max-width: 360px;
  background: #fff;
  border: 1px solid #bbb;
  border-radius: 8px;
  box-shadow: 0 10px 24px rgba(0,0,0,0.18);
  padding: 12px 12px 10px 12px;
  z-index: 10000;
}

.help-popover-title {
  font-weight: 700;
  margin-bottom: 6px;
}

.help-popover-body p { margin: 6px 0; }
.help-popover-body ul { margin: 6px 0 0 18px; }

.filters { position: relative; }


  </style>
</head>
<body>
  <h1>Course Projections</h1>
  <h2>College of the Atlantic</h2>

  <!-- Filters -->
  <div class="filters">
    <label>
      Instructor:
      <select id="filter-instructor">
        <option value="">All</option>
      </select>
    </label>
    <label>
      Requirements:
      <select id="filter-requirements">
        <option value="">All</option>
      </select>
    </label>
    <label>
      Level:
      <select id="filter-level">
        <option value="">All</option>
      </select>
    </label>

    <!-- NEW: global text search -->
    <label>
      Search:
      <input type="text" id="global-search" placeholder="Search all terms…" />
      <button type="button" class="help-icon" aria-label="Help" aria-expanded="false">?</button>
    </label>
  </div>


<div id="help-popover" class="help-popover" role="dialog" aria-hidden="true">
  <div class="help-popover-title">Help</div>
  <div class="help-popover-body">
    <p><b>Search</b> filters courses across all terms.</p>
    <p>Use the dropdowns to filter by Instructor, Requirement, and Level.</p>
    <ul>
      <li>Click a course title for the description.</li>
      <li>Click “Additional Information” for bonus info.</li>
    </ul>
  </div>
</div>
  
  <!-- Top horizontal scrollbar -->
  <div id="top-scroll" class="top-scroll">
    <div id="top-scroll-inner"></div>
  </div>

<div class="scroll-hint">
  <div id="term-tables" class="term-tables"></div>
</div>

  

  
  <! -- orig -->
  <!-- Container for all term tables -->
  <!--<div id="term-tables" class="term-tables">-->
    <!-- JS will inject one .term-column with a table per term -->
  <!--</div>-->

  <!-- implement scrolling hint -->
  <div class="scroll-hint">
    <div id="term-tables" class="term-tables"></div>
  </div>


  <!-- Modal -->
  <div id="desc-backdrop" class="modal-backdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal" role="document">
      <div class="modal-header">
        <div id="desc-title" class="modal-title"></div>
        <button id="desc-close" class="modal-close" aria-label="Close">×</button>
      </div>
      <div id="desc-body" class="modal-body"></div>
    </div>
  </div>

  <!-- jQuery and DataTables JS -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>


  <script>
    // ---- Helpers ----
    function escapeRegex(text) {
      return String(text).replace(/[.*+?^${}()|[\\]\\\\]/g, '\\$&');
    }

    function tokenizeRequirements(cell) {
      if (!cell) return [];
      const raw = String(cell).replace(/\\u00A0/g, ' ').trim();
      if (!raw) return [];
      const rough = raw.split(/[\\s,;|/()\\-]+/u).map(t => t.trim()).filter(Boolean);
      const out = new Set(rough.map(t => t.toUpperCase()));
      const KNOWN = ["ES","QR","AD","ADS"];
      for (const code of KNOWN) {
        const re = new RegExp(`(^|[\\s,;|/()\\-])${code}([\\s,;|/()\\-]|$)`, 'i');
        if (re.test(raw)) out.add(code);
      }
      return Array.from(out);
    }

// Sort Course Name so items starting with '[' come last (e.g., "[no classes]")
$.fn.dataTable.ext.type.order['course-name-bracket-last-pre'] = function (d) {
  // d might be HTML (button) or plain text; convert to visible text
  const text = $('<div>').html(d).text().trim().toLowerCase();

  // Put bracket-starting entries after everything else
  if (text.startsWith('[')) {
    // Prefix with a very high Unicode char so it sorts after letters
    return '\uffff' + text;
  }
  return text;
};

    
    function openModal(title, body) {
      const backdrop = document.getElementById('desc-backdrop');
      const titleEl = document.getElementById('desc-title');
      const bodyEl = document.getElementById('desc-body');
      titleEl.innerHTML = title || '';
      bodyEl.innerHTML  = body || '(No description provided)'; // allow simple HTML in descriptions/bonus
      backdrop.style.display = 'flex';
      backdrop.setAttribute('aria-hidden', 'false');
      document.getElementById('desc-close').focus();
    }
    function closeModal() {
      const backdrop = document.getElementById('desc-backdrop');
      backdrop.style.display = 'none';
      backdrop.setAttribute('aria-hidden', 'true');
    }

    // Old version, didn't display things in correct chronological order
    // Map term codes like F25, W26, S26 to sorting keys and labels
    // function termSortKey(code) {
    //  if (!code) return Number.POSITIVE_INFINITY;
    //   const c = code.trim().toUpperCase();
    //  const season = c[0];
    //  const yearPart = parseInt(c.slice(1), 10);
    //  const seasonOrder = { F: 0, W: 1, S: 2 }; // Fall -> Winter -> Spring
    //  const so = seasonOrder[season] !== undefined ? seasonOrder[season] : 9;
    //  return yearPart * 10 + so;
    // }

    function termSortKey(code) {
	if (!code) return Number.POSITIVE_INFINITY;
	const c = code.trim().toUpperCase();
	const season = c[0];
	const yearPart = parseInt(c.slice(1), 10);
	if (Number.isNaN(yearPart)) return Number.POSITIVE_INFINITY;
	
	let academicStart; // academic year starts in Fall
	let offset;
	
	if (season === 'F') {
	    // Fall 25 belongs to academic year 25
	    academicStart = yearPart;
	    offset = 0; // Fall
	} else if (season === 'W') {
	    // Winter 26 belongs to academic year 25
	    academicStart = yearPart - 1;
	    offset = 1; // Winter
	} else if (season === 'S') {
	    // Spring 26 belongs to academic year 25
	    academicStart = yearPart - 1;
	    offset = 2; // Spring
	} else {
	    // Unknown season: push to the end
	    academicStart = yearPart;
	    offset = 9;
	}

	// Any monotone function of (academicStart, offset) works:
	return academicStart * 10 + offset;
    }

    
    function termLabel(code) {
      const c = code.trim().toUpperCase();
      const seasonMap = { F: "Fall", W: "Winter", S: "Spring" };
      const season = seasonMap[c[0]] || c[0];
      const year = "20" + c.slice(1); // F25 -> 2025
      return `${season} ${year} (${c})`;
    }


/*function syncHorizontalScroll() {
  const top = document.getElementById('top-scroll');
  const bottom = document.getElementById('term-tables');
  const topInner = document.getElementById('top-scroll-inner');

  if (!top || !bottom || !topInner) return;

  // Match widths so scrollbar sizes line up
  topInner.style.width = bottom.scrollWidth + 'px';


    
  // Sync scrolling
  let isSyncingTop = false;
  let isSyncingBottom = false;

  top.addEventListener('scroll', () => {
    if (!isSyncingTop) {
      isSyncingBottom = true;
      bottom.scrollLeft = top.scrollLeft;
    }
    isSyncingTop = false;
  });

  bottom.addEventListener('scroll', () => {
    if (!isSyncingBottom) {
      isSyncingTop = true;
      top.scrollLeft = bottom.scrollLeft;
    }
    isSyncingBottom = false;
  });
}*/

function syncHorizontalScroll() {
  const top = document.getElementById('top-scroll');
  const bottom = document.getElementById('term-tables');
  const topInner = document.getElementById('top-scroll-inner');
  if (!top || !bottom || !topInner) return;

  // Recompute width every time
  topInner.style.width = bottom.scrollWidth + 'px';

  // Keep positions matched
  top.scrollLeft = bottom.scrollLeft;

  // Assign (don’t stack) handlers
  top.onscroll = () => { bottom.scrollLeft = top.scrollLeft; };
  bottom.onscroll = () => { top.scrollLeft = bottom.scrollLeft; };
}

    
    
    Papa.parse( //"./multi_term_test.csv", { // <-- change to your CSV filename
	"./projections_output.csv", { // <-- change to your CSV filename
      download: true,
      header: true,
      complete: function (results) {
        const rawData = results.data || [];
        const data = rawData.filter(r => (r["FacultyName"] || '').trim() && (r["Term"] || r["term"] || '').trim());

        const termTablesContainer = document.getElementById("term-tables");

        // Figure out unique terms
        const termSet = new Set(
          data.map(r => (r["Term"] || r["term"] || '').trim()).filter(Boolean)
        );
        const terms = Array.from(termSet).sort((a,b) => termSortKey(a) - termSortKey(b));

        // Build one table per term
        terms.forEach(termCode => {
          const termCourses = data.filter(r => (r["Term"] || r["term"]).trim() === termCode);
          if (!termCourses.length) return;

          const colDiv = document.createElement("div");
          colDiv.className = "term-column";

          const h3 = document.createElement("h3");
          h3.textContent = termLabel(termCode);
          colDiv.appendChild(h3);

          const tableId = `courses-${termCode}`;
          const table = document.createElement("table");
          table.id = tableId;
          table.className = "display term-table";

          table.innerHTML = `
            <thead>
              <tr>
                <th>Faculty Name</th>
                <th>Course Name</th>
                <th>Reqs Met</th>
                <th>Level</th>
                <th>Bonus Info</th>
                <th>Description</th>
                <th>BonusRaw</th>
              </tr>
            </thead>
            <tbody></tbody>
          `;
          colDiv.appendChild(table);
          termTablesContainer.appendChild(colDiv);

          const tbody = table.querySelector("tbody");

          termCourses.forEach(row => {
            const tr = document.createElement("tr");
            const courseName = row["CourseName"] ?? '';
            const bonusRaw   = row["Bonus Information"] ?? '';
            const description = row["Description"] ?? '';

            tr.innerHTML = `
              <td>${row["FacultyName"] ?? ''}</td>
              <td>
                <button type="button"
                        class="course-link"
                        aria-haspopup="dialog">
                  ${courseName}
                </button>
              </td>
              <td>${row["CourseDivision"] ?? ''}</td>
              <td>${row["Level"] ?? ''}</td>
              <td>${
                bonusRaw
                  ? '<button type="button" class="bonus-link" aria-haspopup="dialog">Additional Information</button>'
                  : ''
              }</td>
              <td>${description}</td>
              <td>${bonusRaw}</td>
            `;
            tbody.appendChild(tr);
          });
        });

        // Desired custom order for Level: If using unabbreviated levels
        /* const desiredOrder = [
          "Introductory",
          "Introductory/Intermediate",
          "Intermediate",
          "Intermediate/Advanced",
          "Advanced"
        ]; */
	  const desiredOrder = [
          "I",
          "I/M",
          "M",
          "M/A",
          "A"
		  ];
        const levelOrderMap = desiredOrder.reduce((acc, v, i) => { acc[v] = i; return acc; }, {});
        $.fn.dataTable.ext.type.order['level-order-pre'] = function (d) {
          const t = String(d || '').trim();
          return Object.prototype.hasOwnProperty.call(levelOrderMap, t) ? levelOrderMap[t] : 9999;
        };

        // Initialise DataTables for all term tables
        const tables = [];
        $(".term-table").each(function(){
          //const dt = $(this).DataTable({
          //  pageLength: 50,
          //  order: [[1, "asc"]],
          //  dom: 'frtip',
          //  columnDefs: [
          //    { targets: 3, type: 'level-order' },      // Level
          //    { targets: [5,6], visible: false, searchable: false } // Description & BonusRaw hidden
          //  ]
            //});
	    const dt = $(this).DataTable({
		pageLength: 100,
		order: [[1, "asc"]],
		dom: 'lrtip',  // <-- remove the per-table search box (no 'f')
		columnDefs: [
		    { targets: 1, type: 'course-name-bracket-last' }, // <-- NEW: Course Name
		    { targets: 3, type: 'level-order' },
		    { targets: [4,5,6], visible: false, searchable: true }
		]
	    });
          tables.push(dt);
        });

	  setTimeout(syncHorizontalScroll, 50);

	  
	  // Global search across all term tables
	  const globalSearchInput = document.getElementById("global-search");
	  if (globalSearchInput) {
	      globalSearchInput.addEventListener("input", function () {
		  const val = this.value;
		  tables.forEach(dt => {
		      dt.search(val);  // global search across all (searchable) columns
		      dt.draw();
		  });
	      });
	  }

	  
        // Build global filters (Instructor / Requirements / Level) based on ALL data
        const instructors = Array.from(new Set(
          data.map(r => (r["FacultyName"] || '').trim()).filter(Boolean)
        )).sort((a,b) => a.localeCompare(b, undefined, {sensitivity:'base'}));
        const deptSelect = document.getElementById("filter-instructor");
        for (const name of instructors) {
          const opt = document.createElement("option");
          opt.value = name; opt.textContent = name; deptSelect.appendChild(opt);
        }

        const tokenSet = new Set();
        data.forEach(r => tokenizeRequirements(r["CourseDivision"]).forEach(t => tokenSet.add(t)));
        const requirementTokens = Array.from(tokenSet).sort((a,b) => a.localeCompare(b, undefined, {sensitivity:'base'}));
        const reqSelect = document.getElementById("filter-requirements");
        for (const tok of requirementTokens) {
          const opt = document.createElement("option");
          opt.value = tok; opt.textContent = tok; reqSelect.appendChild(opt);
        }

        const presentLevels = new Set(
          data.map(r => (r["Level"] || '').trim()).filter(Boolean)
        );
        const levels = [
          ...desiredOrder.filter(l => presentLevels.has(l)),
          ...Array.from(presentLevels).filter(l => !desiredOrder.includes(l))
                .sort((a,b) => a.localeCompare(b, undefined, {sensitivity:'base'}))
        ];
        const levelSelect = document.getElementById("filter-level");
        for (const lvl of levels) {
          const opt = document.createElement("option");
          opt.value = lvl; opt.textContent = lvl; levelSelect.appendChild(opt);
        }

        // Filtering logic (apply to ALL term tables)
        deptSelect.addEventListener("change", function () {
          const val = this.value;
          tables.forEach(dt => {
            dt.column(0).search(val ? '^' + escapeRegex(val) + '$' : '', true, false);
            dt.draw();
          });
        });

        reqSelect.addEventListener("change", function () {
          const val = this.value;
          tables.forEach(dt => {
            if (val) {
              const boundary = '[\\s,;|/()\\-]';
              const regex = `(^|${boundary})${escapeRegex(val)}(${boundary}|$)`;
              dt.column(2).search(regex, true, false);
            } else {
              dt.column(2).search('', true, false);
            }
            dt.draw();
          });
        });

        levelSelect.addEventListener("change", function () {
          const val = this.value;
          tables.forEach(dt => {
            dt.column(3).search(val ? '^' + escapeRegex(val) + '$' : '', true, false);
            dt.draw();
          });
        });

        // Event delegation for Course Name -> Description modal
        $("#term-tables").on("click", "button.course-link", function(e){
          e.preventDefault();
          const $table = $(this).closest("table");
          const dt = $table.DataTable();
          const row = dt.row($(this).closest("tr"));
          const rowData = row.data();
          const courseTitle = $(this).text();
          const instructor  = rowData[0] || '';
          const description = rowData[5] || '(No description provided)';
          const titleHtml = `<div>${courseTitle}</div><div class="subtitle">Instructor: ${instructor}</div>`;
          openModal(titleHtml, description);
        });

        // Event delegation for Bonus Information -> Bonus modal
        $("#term-tables").on("click", "button.bonus-link", function(e){
          e.preventDefault();
          const $table = $(this).closest("table");
          const dt = $table.DataTable();
          const row = dt.row($(this).closest("tr"));
          const rowData = row.data();
          const courseTitle = $(this).closest("tr").find("button.course-link").text();
          const bonus = rowData[6] || '(No additional information provided)';
          const titleHtml = `<div>${courseTitle}</div><div class="subtitle">Additional Information</div>`;
          openModal(titleHtml, bonus);
        });

        // Modal close interactions
        document.getElementById('desc-close').addEventListener('click', closeModal);
        document.getElementById('desc-backdrop').addEventListener('click', function(e){
          if (e.target === this) closeModal();
        });
        document.addEventListener('keydown', function(e){
          if (e.key === 'Escape') closeModal();
        });
	  syncHorizontalScroll();
	  window.addEventListener('resize', syncHorizontalScroll);

    // Let layout settle, then sync scrollbars
    setTimeout(syncHorizontalScroll, 50);

	  
      }
	});
    </script>

  <script>
    function updateScrollHint() {
	const wrapper = document.querySelector('.scroll-hint');
	const inner = document.getElementById('term-tables');
	if (inner.scrollWidth > wrapper.clientWidth) {
	    wrapper.classList.add('scrollable');
	} else {
	    wrapper.classList.remove('scrollable');
	}
    }
    
    // Run after tables render
    window.addEventListener('load', updateScrollHint);
    window.addEventListener('resize', updateScrollHint);
  </script>

  <script>
    (function () {
  const btn = document.querySelector('.help-icon');
  const pop = document.getElementById('help-popover');
  if (!btn || !pop) return;

  function openPopover() {
    // Position popover near the button
    const b = btn.getBoundingClientRect();
    const parent = document.querySelector('.filters').getBoundingClientRect();

    pop.style.left = (b.left - parent.left) + 'px';
    pop.style.top  = (b.bottom - parent.top + 8) + 'px';

    pop.style.display = 'block';
    pop.setAttribute('aria-hidden', 'false');
    btn.setAttribute('aria-expanded', 'true');
  }

  function closePopover() {
    pop.style.display = 'none';
    pop.setAttribute('aria-hidden', 'true');
    btn.setAttribute('aria-expanded', 'false');
  }

  btn.addEventListener('click', (e) => {
    e.stopPropagation();
    if (pop.style.display === 'block') closePopover();
    else openPopover();
  });

  // Click outside closes
  document.addEventListener('click', () => closePopover());

  // Escape closes
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') closePopover();
  });
})();

  </script>
  
</body>
</html>
